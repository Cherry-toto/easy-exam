<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 在线考试系统</title>
      <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/fontawesome-free-6.7.2/css/all.min.css" rel="stylesheet">
    <script src="/static/js/jquery.min.js"></script>
    
 <script src="https://www.recaptcha.net/recaptcha/api.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        .form-input {
            transition: all 0.3s ease;
        }
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .loading-spinner {
            display: none;
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="login-container w-full max-w-md p-8 fade-in">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-graduation-cap text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">在线考试系统</h1>
                <p class="text-gray-600 mt-2">欢迎回来，请登录您的账户</p>
            </div>

            <!-- 登录表单 -->
            <form id="loginForm" class="space-y-6">
                <!-- 邮箱输入 -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>登录邮箱
                    </label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           required 
                           class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="请输入您的邮箱地址"
                           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                </div>

                <!-- 人机验证按钮 -->
                <div>
                     <div class="g-recaptcha" data-sitekey="6LdW6LErAAAAAHupC67MrpARj3wqeCuIKfIwKayY"></div>
                    <!--<button type="button" -->
                    <!--        id="verifyBtn" -->
                    <!--        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">-->
                    <!--    <i class="fas fa-shield-alt mr-2"></i>-->
                    <!--    <span id="verifyText">点击进行人机验证</span>-->
                    <!--</button>-->
                </div>

                <!-- 登录方式切换 -->
                <div class="flex justify-center mb-6">
                    <div class="inline-flex p-1 bg-gray-100 rounded-lg">
                        <button type="button" 
                                id="emailCodeBtn" 
                                class="px-6 py-2 rounded-md bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-medium transition duration-300">
                            邮箱验证码登录
                        </button>
                        <button type="button" 
                                id="accountPwdBtn" 
                                class="px-6 py-2 rounded-md text-gray-600 font-medium transition duration-300 hover:bg-gray-200">
                            账户密码登录
                        </button>
                    </div>
                </div>

                <!-- 账户密码登录区域 -->
                <div id="accountPwdSection" style="display: none;">
                 
                    <!-- 密码输入 -->
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-2"></i>密码
                        </label>
                        <input type="password" 
                               id="password" 
                               name="password" 
                               required 
                               class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                               placeholder="请输入您的密码">
                    </div>

                    <!-- 密码登录按钮 -->
                    <button type="button" 
                            id="pwdLoginBtn" 
                            class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-medium py-3 px-4 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition duration-300 flex items-center justify-center">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        <span id="pwdLoginText">登录系统</span>
                        <div class="loading-spinner ml-2">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </button>
                </div>

                <!-- 验证码发送区域 -->
                <div id="verifySection" class="fade-in">
                    <button type="button" 
                            id="sendCodeBtn" 
                            class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-medium py-3 px-4 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition duration-300 flex items-center justify-center shadow-md">
                        <i class="fas fa-paper-plane mr-2"></i>
                        <span id="sendCodeText">发送邮箱验证码</span>
                        <div class="loading-spinner ml-2">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </button>
                </div>

                <!-- 验证码输入 -->
                <div id="codeSection" style="display: none;" class="fade-in">
                    <label for="code" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key mr-2"></i>邮箱验证码
                    </label>
                    <div class="flex space-x-3">
                        <input type="text" 
                               id="code" 
                               name="code" 
                               required 
                               maxlength="6" 
                               class="form-input flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="请输入6位验证码"
                               pattern="\d{6}">
                        <button type="button" 
                                id="resendBtn" 
                                class="px-4 py-3 text-sm text-purple-600 hover:text-purple-800 font-medium whitespace-nowrap">
                            重新发送
                        </button>
                    </div>
                    <p id="countdown" class="text-sm text-gray-500 mt-1" style="display: none;">
                        <span id="countdownText">60</span>秒后可重新发送
                    </p>
                </div>

                <!-- 验证码登录按钮 -->
                <div id="loginSection" style="display: none;" class="fade-in">
                    <button type="submit" 
                            id="loginBtn" 
                            class="btn-primary w-full text-white font-medium py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center shadow-md">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        <span id="loginText">登录系统</span>
                        <div class="loading-spinner ml-2">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </button>
                </div>
            </form>

            <!-- 提示信息 -->
            <div id="message" class="mt-4 text-center text-sm" style="display: none;">
                <div id="messageContent" class="p-3 rounded-lg"></div>
            </div>

            <!-- 底部信息 -->
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    首次登录将自动创建账户，无需注册
                </p>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // 登录方式切换
            const emailCodeBtn = $('#emailCodeBtn');
            const accountPwdBtn = $('#accountPwdBtn');
            const verifySection = $('#verifySection');
            const codeSection = $('#codeSection');
            const loginSection = $('#loginSection');
            const accountPwdSection = $('#accountPwdSection');
            const emailInput = $('#email');
            const form = $('#loginForm');

            // 初始状态 - 默认显示邮箱验证码登录
            showEmailCodeLogin();

            // 邮箱验证码登录按钮点击
            emailCodeBtn.click(function() {
                showEmailCodeLogin();
            });

            // 账户密码登录按钮点击
            accountPwdBtn.click(function() {
                showAccountPwdLogin();
            });

            // 显示邮箱验证码登录
            function showEmailCodeLogin() {
                emailCodeBtn.removeClass('text-gray-600 hover:bg-gray-200')
                           .addClass('bg-gradient-to-r from-purple-500 to-indigo-600 text-white');
                accountPwdBtn.removeClass('bg-gradient-to-r from-purple-500 to-indigo-600 text-white')
                            .addClass('text-gray-600 hover:bg-gray-200');

                verifySection.fadeIn();
                // 如果已经发送过验证码，显示验证码输入和登录按钮
                if (codeSection.is(':visible') || loginSection.is(':visible')) {
                    codeSection.fadeIn();
                    loginSection.fadeIn();
                }
                accountPwdSection.hide();
                $("#password").val('');
                emailInput.prop('required', true);
                form.off('submit').submit(function(e) {
                    e.preventDefault();
                    handleEmailCodeLogin();
                });
            }

            // 显示账户密码登录
            function showAccountPwdLogin() {
                accountPwdBtn.removeClass('text-gray-600 hover:bg-gray-200')
                            .addClass('bg-gradient-to-r from-purple-500 to-indigo-600 text-white');
                emailCodeBtn.removeClass('bg-gradient-to-r from-purple-500 to-indigo-600 text-white')
                           .addClass('text-gray-600 hover:bg-gray-200');

                verifySection.hide();
                codeSection.hide();
                loginSection.hide();
                accountPwdSection.fadeIn();
                emailInput.prop('required', false);
            }

            // 账户密码登录按钮点击事件
            $('#pwdLoginBtn').click(function() {
                const email = $('#email').val();
                const password = $('#password').val();

                if (!email.trim()) {
                    shakeElement('#email');
                    showMessage('error', '请输入登录邮箱');
                    return;
                }
                if (!validateEmail(email)) {
                    shakeElement('#email');
                    showMessage('error', '请输入正确的邮箱地址');
                    return;
                }

                if (!password) {
                    shakeElement('#password');
                    showMessage('error', '请输入密码');
                    return;
                }
                loginWithAccountPwd(email, password);
            });

            // 处理邮箱验证码登录
            function handleEmailCodeLogin() {
                const email = $('#email').val();
                const code = $('#code').val();

                if (!validateEmail(email)) {
                    shakeElement('#email');
                    showMessage('error', '请输入正确的邮箱地址');
                    return;
                }

                if (!/^\d{6}$/.test(code)) {
                    shakeElement('#code');
                    showMessage('error', '请输入6位数字验证码');
                    return;
                }

                loginUser(email, code);
            }

            // 账户密码登录
            function loginWithAccountPwd(email, password) {
                const pwdLoginBtn = $('#pwdLoginBtn');
                pwdLoginBtn.prop('disabled', true);
                pwdLoginBtn.find('.loading-spinner').show();
                pwdLoginBtn.find('#pwdLoginText').text('登录中...');
               var recaptcha = $("#g-recaptcha-response").val();
                $.ajax({
                    url: '/checklogin.php',
                    type: 'POST',
                    data: { email: email, password: password, recaptcha: recaptcha, login_type: 'account' },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            showMessage('success', '登录成功，正在跳转...');
                            setTimeout(function() {
                                window.location.href = '/user.html';
                            }, 1500);
                        } else {
                            shakeElement('#password');
                            showMessage('error', response.message || '用户名或密码错误');
                        }
                    },
                    error: function() {
                        showMessage('error', '网络错误，请检查网络连接');
                    },
                    complete: function() {
                        pwdLoginBtn.prop('disabled', false);
                        pwdLoginBtn.find('.loading-spinner').hide();
                        pwdLoginBtn.find('#pwdLoginText').text('登录系统');
                    }
                });
            }

            // 原有代码保留
            let isVerified = false;
            let countdownInterval;

            // 检查是否已登录
            checkLoginStatus();

            // 人机验证按钮点击
            $('#verifyBtn').click(function() {
                isVerified = true;
                $(this).removeClass('bg-gray-100 hover:bg-gray-200 text-gray-700')
                       .addClass('bg-green-100 text-green-700')
                       .html('<i class="fas fa-check mr-2"></i>验证成功');
                $('#verifySection').fadeIn();
                showMessage('success', '人机验证完成，请输入邮箱获取验证码');
            });

            // 发送验证码
            $('#sendCodeBtn').click(function() {
                const email = $('#email').val();
                if (!validateEmail(email)) {
                    shakeElement('#email');
                    showMessage('error', '请输入正确的邮箱地址');
                    return;
                }

                sendVerificationCode(email);
            });

            // 重新发送验证码
            $('#resendBtn').click(function() {
                const email = $('#email').val();
                if (!validateEmail(email)) {
                    shakeElement('#email');
                    showMessage('error', '请输入正确的邮箱地址');
                    return;
                }

                sendVerificationCode(email);
            });

            // 表单提交
            $('#loginForm').submit(function(e) {
                e.preventDefault();
                
                const email = $('#email').val();
                const code = $('#code').val();

                if (!validateEmail(email)) {
                    shakeElement('#email');
                    showMessage('error', '请输入正确的邮箱地址');
                    return;
                }

                if (!/^\d{6}$/.test(code)) {
                    shakeElement('#code');
                    showMessage('error', '请输入6位数字验证码');
                    return;
                }

                loginUser(email, code);
            });

            // 邮箱验证
            function validateEmail(email) {
                const re = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;
                return re.test(email.toLowerCase());
            }

            // 发送验证码
            function sendVerificationCode(email) {
                $('#sendCodeBtn').prop('disabled', true);
                $('#sendCodeBtn .loading-spinner').show();
                $('#sendCodeText').text('发送中...');
                var recaptcha = $("#g-recaptcha-response").val();
                $.ajax({
                    url: '/sendemail.php',
                    type: 'POST',
                    data: { email: email, recaptcha:recaptcha},
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            $('#codeSection').fadeIn();
                            $('#loginSection').fadeIn();
                            startCountdown(60);
                            showMessage('success', '验证码已发送到您的邮箱，请查收');
                        } else {
                            showMessage('error', response.message || '发送失败，请重试');
                        }
                    },
                    error: function() {
                        showMessage('error', '网络错误，请检查网络连接');
                    },
                    complete: function() {
                        $('#sendCodeBtn').prop('disabled', false);
                        $('#sendCodeBtn .loading-spinner').hide();
                        $('#sendCodeText').text('发送邮箱验证码');
                    }
                });
            }

            // 登录用户
            function loginUser(email, code) {
                $('#loginBtn').prop('disabled', true);
                $('#loginBtn .loading-spinner').show();
                $('#loginText').text('登录中...');

                $.ajax({
                    url: '/checklogin.php',
                    type: 'POST',
                    data: { email: email, code: code },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            showMessage('success', '登录成功，正在跳转...');
                            setTimeout(function() {
                                window.location.href = '/user.html';
                            }, 1500);
                        } else {
                            shakeElement('#code');
                            showMessage('error', response.message || '验证码错误或已过期');
                        }
                    },
                    error: function() {
                        showMessage('error', '网络错误，请检查网络连接');
                    },
                    complete: function() {
                        $('#loginBtn').prop('disabled', false);
                        $('#loginBtn .loading-spinner').hide();
                        $('#loginText').text('登录系统');
                    }
                });
            }

            // 倒计时功能
            function startCountdown(seconds) {
                let remaining = seconds;
                $('#countdown').show();
                $('#resendBtn').hide();
                
                countdownInterval = setInterval(function() {
                    $('#countdownText').text(remaining);
                    remaining--;
                    
                    if (remaining < 0) {
                        clearInterval(countdownInterval);
                        $('#countdown').hide();
                        $('#resendBtn').show();
                    }
                }, 1000);
            }

            // 显示消息
            function showMessage(type, message) {
                const messageDiv = $('#message');
                const contentDiv = $('#messageContent');
                
                contentDiv.removeClass('bg-green-100 text-green-700 bg-red-100 text-red-700');
                
                if (type === 'success') {
                    contentDiv.addClass('bg-green-100 text-green-700');
                } else {
                    contentDiv.addClass('bg-red-100 text-red-700');
                }
                
                contentDiv.text(message);
                messageDiv.fadeIn();
                
                setTimeout(function() {
                    messageDiv.fadeOut();
                }, 3000);
            }

            // 元素抖动效果
            function shakeElement(selector) {
                $(selector).addClass('shake');
                setTimeout(function() {
                    $(selector).removeClass('shake');
                }, 500);
            }

            // 检查登录状态
            function checkLoginStatus() {
                $.ajax({
                    url: '/checklogin.php',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.logged_in) {
                            window.location.href = '/index.php';
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>